"use strict";(()=>{var e={};e.id=4912,e.ids=[4912],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},76162:e=>{e.exports=require("stream")},82452:e=>{e.exports=require("tls")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},8678:e=>{e.exports=import("pg")},78214:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>g,patchFetch:()=>c,requestAsyncStorage:()=>p,routeModule:()=>u,serverHooks:()=>E,staticGenerationAsyncStorage:()=>d});var o=r(49303),a=r(88716),i=r(60670),n=r(19834),l=e([n]);n=(l.then?(await l)():l)[0];let u=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/auth/[...nextauth]/route",pathname:"/api/auth/[...nextauth]",filename:"route",bundlePath:"app/api/auth/[...nextauth]/route"},resolvedPagePath:"/Users/daniel.claessen/Desktop/Projects/exulu/frontend/app/api/auth/[...nextauth]/route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:d,serverHooks:E}=u,g="/api/auth/[...nextauth]/route";function c(){return(0,i.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:d})}s()}catch(e){s(e)}})},19579:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{b:()=>x,d:()=>w});var o=r(14029),a=r(53797),i=r(55245),n=r(84770),l=r(1203),c=r(8678),u=r(98691),p=r(35515),d=r(30849),E=r(77234),g=e([c]);c=(g.then?(await g)():g)[0];let m=async e=>{let t=process.env.NEXTAUTH_SECRET,r=await (0,p.nO)({k:t,alg:"HS256",kty:"oct"});return await new d.N(e).setProtectedHeader({alg:"HS256"}).setIssuedAt().setExpirationTime("365d").sign(r)},w=new c.Pool({host:process.env.POSTGRES_DB_HOST,user:process.env.POSTGRES_DB_USER,port:parseInt(process.env.POSTGRES_DB_PORT||"5432",10),password:process.env.POSTGRES_DB_PASSWORD,database:process.env.POSTGRES_DB_NAME||"exulu",min:2,max:20,acquireTimeoutMillis:3e4,createTimeoutMillis:3e4,idleTimeoutMillis:3e4,reapIntervalMillis:1e3,createRetryIntervalMillis:200,connectionTimeoutMillis:1e4}),h=[(0,a.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},authorize:async e=>{let t=await w.connect();try{if(!e?.email||!e?.password)return null;let r=await t.query("SELECT * FROM users WHERE email = $1",[e.email]);if(console.log("[NEXT AUTH] authorize res rows count:",r.rows.length),console.log("[NEXT AUTH] Full user object:",JSON.stringify(r.rows[0],null,2)),!r?.rows?.length)return null;for(let s of r.rows){let r=await u.ZP.compare(e.password,s.password);if(console.log("[NEXT AUTH] isMatch",r),r)return await t.query("UPDATE users SET last_used = $1 WHERE email = $2",[new Date,s.email]),s}}finally{t.release()}}})];process.env.EMAIL_SERVER_HOST&&h.push((0,o.Z)({async sendVerificationRequest({identifier:e,token:t,url:r,provider:{server:s,from:o}}){var a;let{host:n}=new URL(r),l=(0,i.createTransport)(s);await l.sendMail({to:e,from:o,subject:`Sign in to ${n}`,text:(a={token:t,host:n},`
  Sign in to ${a.host}
  
  Sign in code: ${a.token}
  
  Keep in mind that this code will expire after 3 minutes. If you did not request this email you can safely ignore it.
  `),html:function(e){let{token:t,host:r}=e,s=r.replace(/\\./g,"&#8203;."),o={background:"#f9f9f9",text:"#444",mainBackground:"#fff"};return`
<body style="background: ${o.background};">
  <table width="100%" border="0" cellspacing="20" cellpadding="0"
    style="background: ${o.mainBackground}; max-width: 600px; margin: auto; border-radius: 10px;">
    <tr>
      <td align="center"
        style="padding: 10px 0px; font-size: 22px; font-family: Helvetica, Arial, sans-serif; color: ${o.text};">
        Sign in to <strong>${s}</strong>
      </td>
    </tr>
    <tr>
      <td align="center" style="padding: 20px 0;">
        <table border="0" cellspacing="0" cellpadding="0">
          <tr>
            <td align="center"><strong>Sign in code:</strong> ${t}</td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td align="center"
        style="padding: 0px 0px 10px 0px; font-size: 16px; line-height: 22px; font-family: Helvetica, Arial, sans-serif; color: ${o.text};">
        Keep in mind that this code will expire after <strong><em>3 minutes</em></strong>. If you did not request this email you can safely ignore it.
      </td>
    </tr>
  </table>
</body>
  `}({token:t,host:n})})},generateVerificationToken:async()=>(0,n.randomInt)(1e5,999999).toString(),maxAge:180,server:{host:process.env.EMAIL_SERVER_HOST,port:parseInt(process.env.EMAIL_SERVER_PORT,10),auth:{user:process.env.EMAIL_SERVER_USER,pass:process.env.EMAIL_SERVER_PASSWORD}},from:process.env.EMAIL_FROM})),process.env.GOOGLE_CLIENT_ID&&process.env.GOOGLE_CLIENT_SECRET&&h.push((0,E.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET,authorization:{params:{access_type:"offline",response_type:"code",scope:"https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/directory.readonly https://www.googleapis.com/auth/user.emails.read https://www.googleapis.com/auth/admin.directory.group.readonly https://www.googleapis.com/auth/admin.directory.user.readonly https://www.googleapis.com/auth/userinfo.email openid"}}}));let x=async()=>({pages:{signIn:"/login"},adapter:(0,l.Z)(w),session:{strategy:"jwt"},jwt:{secret:process.env.NEXTAUTH_SECRET},providers:h,callbacks:{async signIn({account:e,profile:t,user:r}){let s=await w.connect();try{let o=r.email;if(console.log("[EXULU] Sign in callback",e,t,r),e?.provider==="google"&&!(o=t?.email))return console.error("[EXULU] Google auth failed, no email in profile."),s.release(),!1;if(console.log("[EXULU] ALLOWED_EMAIL_DOMAINS",process.env.ALLOWED_EMAIL_DOMAINS),process.env.ALLOWED_EMAIL_DOMAINS){let e=process.env.ALLOWED_EMAIL_DOMAINS.split(",");if(e.push("exulu.com"),e.push("qventu.com"),!e.some(e=>o.endsWith(`@${e}`)))return s.release(),!1}let a=await s.query("SELECT * FROM users WHERE email = $1",[o]),i=a?.rows[0];if(console.log("[EXULU] Sign in callback user query result",i),i&&await s.query("UPDATE users SET last_used = $1 WHERE email = $2",[new Date,o]),!i&&e?.provider==="google"){let e=t?.given_name||"",r=await s.query("SELECT * FROM roles WHERE name = $1",["default"]),a=r?.rows[0],n=await s.query('INSERT INTO users ("email", "name", "createdAt", "updatedAt", "emailVerified", "last_used", "type", "super_admin", "role") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9) RETURNING *',[o,e,new Date,new Date,new Date,new Date,"user",!1,a?.id]);i=n?.rows[0],console.log("[EXULU] Sign in callback new user query result",i)}if(i){if(e?.provider==="google"){console.log("[EXULU] Checking for existing account (provider account id: ",e.providerAccountId);let t=(await s.query('SELECT * FROM accounts WHERE provider = $1 AND "providerAccountId" = $2',["google",e.providerAccountId])).rows[0];console.log("[EXULU] Existing account query result",t),t?await s.query('UPDATE accounts SET access_token = $1, refresh_token = $2, expires_at = $3, id_token = $4, scope = $5, session_state = $6, token_type = $7, "userId" = $8 WHERE id = $9',[e.access_token,e.refresh_token,e.expires_at,e.id_token,e.scope,e.session_state,e.token_type,i.id,t.id]):await s.query('INSERT INTO accounts ("provider", "providerAccountId", "access_token", "refresh_token", "expires_at", "id_token", "scope", "session_state", "token_type", "userId", "type") VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11)',["google",e.providerAccountId,e.access_token,e.refresh_token,e.expires_at,e.id_token,e.scope,e.session_state,e.token_type,i.id,"oauth"])}return s.release(),!0}return s.release(),!1}catch(e){return console.error("[EXULU] Sign in callback error",e),s.release(),!1}},async jwt({token:e,user:t}){e.uid=e.sub??"nosub";let r=await m({id:t?t.id:e.sub,email:t?t.email:e.email});return e.jwt=r,e},session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.jwt=t.jwt,e.user.email=t.email),e)},secret:process.env.NEXTAUTH_SECRET});s()}catch(e){s(e)}})},19834:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>l,POST:()=>l,dynamic:()=>c});var o=r(75571),a=r.n(o),i=r(19579),n=e([i]);i=(n.then?(await n)():n)[0];let c="force-dynamic";async function l(e,t){let r=await (0,i.b)();return await a()(e,t,r)}s()}catch(e){s(e)}})},49303:(e,t,r)=>{e.exports=r(30517)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,3543],()=>r(78214));module.exports=s})();